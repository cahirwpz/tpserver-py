#!/usr/bin/env python

import sys

sys.path.insert(0, '.')
sys.path.insert(0, 'tests')
sys.path.insert(0, 'libtpproto2-py')

from twisted.internet import reactor

from tp.server.logging import Logger
from tp.server.model import DatabaseManager

from configuration import CLIConfigurator, ConfigurationError
from configuration import LoggerConfiguration, DatabaseConfiguration

from testrunner import TestRunner, TestRunnerConfiguration
from client import ThousandParsecClientFactory, ThousandParsecClientFactoryConfiguration

def main():
	logger = Logger()
	runner = TestRunner()

	configurator = CLIConfigurator( "Thousand Parsec Test Client" )
	configurator.registerComponent( logger, LoggerConfiguration() )
	configurator.registerComponent( runner, TestRunnerConfiguration() )
	configurator.registerComponent( ThousandParsecClientFactory(), ThousandParsecClientFactoryConfiguration() )
	configurator.registerComponent( DatabaseManager(), DatabaseConfiguration() )

	try:
		configurator.configParse()
		configurator.configCommit()
	except ConfigurationError, ex:
		configurator.help()

		raise SystemExit( '\033[31;1mConfiguration error:\033[0m %s' % ex )

	logger.start()
	runner.start()
	reactor.run()

if __name__ == '__main__':
	main()
