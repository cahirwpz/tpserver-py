#! /usr/bin/env python

import os.path
if not os.path.exists('config.py'):
	print "WARNING: No config.py found, setting one up for you."
	import shutil
	shutil.copy('config.py-template', 'config.py')

import sys, socket
sys.path.append(".")
sys.path.append("/etc/tpserver-py")
import config

from tp.server import FullServer

def main():
	port = 6923
	try:
		while True:
			try:
				s = FullServer("", port, port+1)
				print "Used port", port
			except socket.error, e:
				if e == (99, 'Cannot assign requested address'):
					print e
					break

				print e, "This port in use...", port
				port += 1
				continue
			
			s.serve_forever()
	except KeyboardInterrupt:
		# FIXME: Should notify clients, or should at least explicitely
		# close all open connections.
		print "Interrupted by keyboard; exiting"

if __name__ == "__main__":
	main()

