#! /usr/bin/env python

import sys
sys.path.append("/etc/tpserver-py")
import config

from tp.server.utils import *
from config import db, netlib

def main():
	# Connect to the database
	db.begin()

	try:
		# Use the corret database
		db.query("USE %(database)s", database=sys.argv[1])
		
		# Clean up any phoney orders

		# Get all the orders
		d = {}
		OrderGet(Object(0), d)

		for type in [str(m.__name__) for m in config.order]:
			print type
			if "orders" in type:
				if not d.has_key(type):
					continue

				for order in d[type]:
					order.do()
		
			elif "actions" in type:
				__import__(type, globals(), locals(), ["do"]).do(Object(0))
		
		# Reparent the universe
		
	except:
		db.rollback()
		raise
	else:
		db.commit()
	
if __name__ == "__main__":
	main()


