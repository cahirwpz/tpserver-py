#! /usr/bin/env python

import sys
sys.path.append("/etc/tpserver-py")
import config
from types import TupleType

from tp.server.utils import *
from config import db, netlib

def main():
	# Connect to the database
	db.begin()

	try:
		# Use the corret database
		db.query("USE %(database)s", database=sys.argv[1])
		
		# Clean up any phoney orders

		# Get all the orders
		d = {}
		OrderGet(Object(0), d)

		for action in config.order:
			if type(action) == TupleType:
				action, args = action[0], action[1:]
			else:
				args = tuple()
			
			name = str(action.__name__)
			if "orders" in name:
				sys.stdout.write(r"[01;32m")
				print name, args
				sys.stdout.write(r"[00m")
			
				if not d.has_key(name):
					continue

				for order in d[name]:
					order.do(*args)
		
			elif "actions" in name:
				sys.stdout.write(r"[01;34m")
				print name, args
				sys.stdout.write(r"[00m")
			
				__import__(name, globals(), locals(), ["do"]).do(Object(0), *args)
		
		# Reparent the universe
		
	except:
		db.rollback()
		raise
	else:
		db.commit()
	
if __name__ == "__main__":
	main()


